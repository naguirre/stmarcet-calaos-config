<?xml version="1.0" encoding="UTF-8" ?>
<calaos:rules xmlns:calaos="http://www.calaos.fr">
    <calaos:rule name="Plages horraire chauffage jour" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_3" oper="==" val="true" />
        </calaos:condition>
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="intern_0" val="" val_var="intern_1" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Plages horraire chauffage nuit" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="intern_0" val="" val_var="intern_2" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Changement consigne jour" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_3" oper="==" val="true" />
        </calaos:condition>
        <calaos:condition type="output" trigger="true">
            <calaos:output id="intern_1" oper="==" val="changed" />
        </calaos:condition>
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="intern_0" val="" val_var="intern_1" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Changement consigne nuit" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:condition type="output" trigger="true">
            <calaos:output id="intern_2" oper="==" val="changed" />
        </calaos:condition>
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="intern_0" val="" val_var="intern_2" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Depart en vacances" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_3" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="intern_0" val="6" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Retour Vacances" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_0" oper="==" val="" val_var="intern_2" />
        </calaos:condition>
    </calaos:rule>
    <calaos:rule name="Météo" specialType="" type="Général">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_9" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="script">
            <calaos:script type="lua">
                <![CDATA[local temp = calaos:getInputValue("input_4")
local ext_temp = calaos:getInputValue("input_2")
local pressure = calaos:getInputValue("input_5")
local humidity = calaos:getInputValue("input_6")
local temp_max = calaos:getInputValue("input_8")
local temp_min = calaos:getInputValue("input_7")
local temps = calaos:getInputValue("input_10")
local str = "La température dans le salon est de " .. temp .. " ° Celcius. La température extérieure est de " .. ext_temp .. "° Celcius, " .. temps .. " !"
calaos:setOutputValue("output_3", str)
return true]]>
</calaos:script>
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Karotz ambiance température" specialType="" type="Général">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_4" oper="==" val="changed" />
        </calaos:condition>
        <calaos:action type="script">
            <calaos:script type="lua">
                <![CDATA[local temp = tonumber(calaos:getInputValue("input_4"))

if temp < 10.0 then
    --blanc
    str = "set #60FFFF"
elseif temp >= 10.0 and temp < 15.0 then
    --bleu clair
    str = "set #28FFFF"
elseif temp >= 15.0 and temp < 19.0 then
    --bleu foncé
    str = "set #0060FF"
elseif temp >= 19.0 and temp < 22.0 then
    -- vert
    str = "set #28FF28"
elseif temp >= 22.0 and temp < 25.0 then
    -- Jaune
    str = "set #7AFF00"
elseif temp >= 25.0 and temp < 28.0 then
    -- Orange
    str = "set #FFFF00"
elseif temp > 28.0 then
    -- Rouge
    str = "set #FF3D00"
end
print(str)
calaos:setOutputValue("output_8", str)
return true]]>
</calaos:script>
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Temps change" type="Général">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_11" oper="==" val="changed" />
        </calaos:condition>
        <calaos:action type="script">
            <calaos:script type="lua">
                <![CDATA[temps = calaos:getInputValue("input_11")
local http = require("socket.http")

if temps >= 200 and temps < 300 then
   -- Attention
   left = 6
   right = 16
elseif temps >= 300 and temps < 800 then
   -- Pluie
   left = 6
   right = 6
elseif temps >= 800 and temps < 900 then
   -- Beau temps
   left = 0
   right = 0
elseif temps >= 900 and temps < 957 then
   -- Normal
   left = 0
   right = 0
else
   -- Attention
   left = 6
   right = 16
end



url = "http://192.168.1.72/cgi-bin/ears?left=" .. left .. "&right=" .. right .. "&noreset=0"

http.request(url)

return true
]]>
</calaos:script>
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="trigger programmation sieste" type="Général">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_15" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="intern_5" val="inc 1" />
        </calaos:action>
        <calaos:action type="standard">
            <calaos:output id="input_16" val="true" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Timer compteur sieste expire" type="Général">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_16" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="script">
            <calaos:script type="lua">
                <![CDATA[local http = require("socket.http")
function SecondsToClock(sSeconds)
    local nSeconds = sSeconds
    if nSeconds == 0 then
        --return nil;
        return "00:00:00";
    else
        nHours = string.format("%02.f", math.floor(nSeconds/3600));
        nMins = string.format("%02.f", math.floor(nSeconds/60 - (nHours*60)));
        nSecs = string.format("%02.f", math.floor(nSeconds - nHours*3600 - nMins *60));
        return nHours..":"..nMins..":"..nSecs..":000"
    end
end

cpt = calaos:getInputValue("intern_5")
str = SecondsToClock(cpt * 30 * 60)
print(str)
calaos:setOutputValue("input_17", "stop")
calaos:setOutputValue("input_17", str)
calaos:setOutputValue("input_17", "start")
local str = "Fin de la sieste programmée dans " .. (cpt * 30) .. " minutes."
calaos:setOutputValue("output_3", str)
calaos:setOutputValue("intern_5", 0)
return true]]>
</calaos:script>
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="fin de sieste" type="Général">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_17" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="output_3" val="Fin de la sieste" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Horraires Wifi On" type="Bureau">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_1" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="io_7" val="true" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Horraires Wifi Off" type="Bureau">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_1" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="io_7" val="false" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Btn Telco DIO 2 ON" type="Salon">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="io_2" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="io_7" val="true" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="Btn Telco DIO 2 OFF" type="Salon">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="io_3" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="io_7" val="false" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="lumiére douce ON" type="Chambre d&apos;Emma">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_6" oper="==" val="true" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="output_4" val="set #141010" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="lumiére douce off" type="Chambre d&apos;Emma">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_6" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="output_4" val="false" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="chauffage on" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_4" oper="INF=" val="" val_var="intern_0" />
        </calaos:condition>
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="output_0" val="true" />
        </calaos:action>
    </calaos:rule>
    <calaos:rule name="chauffage off" specialType="" type="Bar">
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="input_4" oper="SUP" val="" val_var="intern_0" />
        </calaos:condition>
        <calaos:condition type="standard" trigger="true">
            <calaos:input id="intern_3" oper="==" val="false" />
        </calaos:condition>
        <calaos:action type="standard">
            <calaos:output id="output_0" val="false" />
        </calaos:action>
    </calaos:rule>
</calaos:rules>
